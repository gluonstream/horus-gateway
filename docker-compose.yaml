version: "3.9"

services:
  keycloak:
    container_name: keycloak-openid-provider
    image: quay.io/keycloak/keycloak:26.5.0

    command:
      - start-dev
      - --import-realm

    ports:
      # Expose Keycloak on host port 7000
      - "7000:8080"

    volumes:
      # Realm JSON files go here (imported only on first startup)
      - ./keycloak:/opt/keycloak/data/import
      # This persists Keycloak data (comment out if you want fresh imports every time)
      - keycloak_data:/opt/keycloak/data

    environment:
      # Admin user (dev only)
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}

      # External hostname configuration (must match exposed port)
      KC_HOSTNAME_URL: http://localhost:7000
      KC_HOSTNAME_ADMIN_URL: http://localhost:7000

      # HTTP / health / metrics
      KC_HTTP_ENABLED: true
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true

    extra_hosts:
      - "host.docker.internal:host-gateway"

    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://localhost:8080/health/live || exit 1"
        ]
      interval: 5s
      timeout: 5s
      retries: 20

# Comment if you don't want persistent Keycloak data
volumes:
   keycloak_data:
